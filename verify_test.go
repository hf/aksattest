package aksattest

import (
	"crypto/x509"
	"encoding/base64"
	tst "testing"
	"time"
)

func TestVerifyExample(t *tst.T) {
	// generated on a Samsung S10e
	certStrings := []string{
		"MIICxTCCAmugAwIBAgIBATAKBggqhkjOPQQDAjApMRkwFwYDVQQFExA1ZjNiY2NjNzhmNDJhYTNlMQwwCgYDVQQMDANURUUwHhcNMTgxMjAzMjIxODQ4WhcNMjgxMTMwMjIxODQ4WjAfMR0wGwYDVQQDDBRBbmRyb2lkIEtleXN0b3JlIEtleTBZMBMGByqGSM49AgEGCCqGSM49AwEHA0IABNElm9HE3mZj1FvMQr0fxZr4UfB98edcp7WvXetaNVf6ex9jOja8TYb-qdXrvryWtGwM4o1fUbUX6GJJeS0y49qjggGMMIIBiDCCAXQGCisGAQQB1nkCAREEggFkMIIBYAIBAwoBAQIBBAoBAQQga2qsETojhBsuuqpPOG6Oj9KmqiSGVwrKuMDlerZRpcAEADB4v4MQCAIGAX_GqRsAv4MRCAIGAYD7pqsAv4MSCAIGAYD7pqsAv4U9CAIGAX_GqRsEv4VFRARCMEAxGjAYBBNhcHAua2V5bWludC5hbmRyb2lkAgEBMSIEIDQ49O2BVYTYNctG0QcKxQNxasrKF7G7n0BcvhB1fuf3MIGzoQgxBgIBAgIBA6IDAgEDowQCAgEApRQxEgIBAAIBAgIBAwIBBAIBBQIBBqoDAgEBv4N3AgUAv4U-AwIBAL-FQEwwSgQgnXdHT6T-pvCyhjYiL7zuK7Hm_5hWxzbIW46m40Z_K7oBAf8KAQAEIH5phQs-c-QnODJm45Hw__wRSCnq06BdvaA8TeZjTxjDv4VBBQIDAdTAv4VCBQIDAxXav4VOBgIEATSJKb-FTwYCBAE0iSkwDgYDVR0PAQH_BAQDAgeAMAoGCCqGSM49BAMCA0gAMEUCIQDOWzOalPblxEB0-9NkdIeoh_EwXQwPIiQ2cY7z8pBADQIgTrggu5xqRV2Ojeiv3FWM52ahOT9j5mTFQuKiPn6pyLM",
		"MIICJjCCAaugAwIBAgIKCWNViWNBVBiYlTAKBggqhkjOPQQDAjApMRkwFwYDVQQFExBmNzc4NzllZTI0ODAwYTY2MQwwCgYDVQQMDANURUUwHhcNMTgxMjAzMjIxODQ4WhcNMjgxMTMwMjIxODQ4WjApMRkwFwYDVQQFExA1ZjNiY2NjNzhmNDJhYTNlMQwwCgYDVQQMDANURUUwWTATBgcqhkjOPQIBBggqhkjOPQMBBwNCAAR7s-vDCa7KpWHFPeAvw8nX6985qPAHpExfAPPBY3yrYcGy4zY1ugNrNLsck2BlA8RHFwhpnG4L2Vij8DZqfmUJo4G6MIG3MB0GA1UdDgQWBBRWPr4wuB6V-K4FP20lswLdLp-aUjAfBgNVHSMEGDAWgBS1X8IM09E-6VlpQxRYUMvqlB3iyTAPBgNVHRMBAf8EBTADAQH_MA4GA1UdDwEB_wQEAwICBDBUBgNVHR8ETTBLMEmgR6BFhkNodHRwczovL2FuZHJvaWQuZ29vZ2xlYXBpcy5jb20vYXR0ZXN0YXRpb24vY3JsLzA5NjM1NTg5NjM0MTU0MTg5ODk1MAoGCCqGSM49BAMCA2kAMGYCMQCJ6de2nGllcIbcUxwxZslel7TmybPxZMijuvbVGv7T_VJjy5qg4NJFL0ZPYxNFibACMQCyto4ROisOYRjHQ5Cj8ihJJW8ngPidrt79rCIj4u9D9S-GvDTeXmwJyo51dMXd_zs",
		"MIID0TCCAbmgAwIBAgIKA4gmZ2BliZaFzDANBgkqhkiG9w0BAQsFADAbMRkwFwYDVQQFExBmOTIwMDllODUzYjZiMDQ1MB4XDTE4MTIwMzIyMDM0MloXDTI4MTEzMDIyMDM0MlowKTEZMBcGA1UEBRMQZjc3ODc5ZWUyNDgwMGE2NjEMMAoGA1UEDAwDVEVFMHYwEAYHKoZIzj0CAQYFK4EEACIDYgAEKuZTvF9FiLxXasiE1WaH4zOrrpS9HStrwwEsnKed7T3w4MZmS-SUb2OduaHAJqDlaItjLectShx8nSn7MLqFJ50IsQNe0Rjij5pPar-VQQExmzyjV1Ihn3WB7XrDFYFzo4G2MIGzMB0GA1UdDgQWBBS1X8IM09E-6VlpQxRYUMvqlB3iyTAfBgNVHSMEGDAWgBQ2YeEAfIgFCVGLRGxH_xpMyepPEjAPBgNVHRMBAf8EBTADAQH_MA4GA1UdDwEB_wQEAwICBDBQBgNVHR8ESTBHMEWgQ6BBhj9odHRwczovL2FuZHJvaWQuZ29vZ2xlYXBpcy5jb20vYXR0ZXN0YXRpb24vY3JsL0U4RkExOTYzMTREMkZBMTgwDQYJKoZIhvcNAQELBQADggIBAIC-gN1zMZjGX8iBEXbZEm0t_gZCWa4fxHOHxo8F18XNXwvn7E4qwTPWJ8hmkWdfqj1bzu6KVr7lqE9gScng5zGf-SYD8DwNvJx9bkGSjELwIUeVwDb9PGjyAUIpXKMJqVwR7_eDlJrtHwOU_jVBAfeYpKqYvDJ3o-PCkfcfgz9CGLhtYStYL2L_bdBePXHnKSIcYbXuaXxfQyLx0DyDMqUiHpXPGALYXJJyYymgW1QL8ZByDOvnPF8nZZudzlxeCA6_l4Cd5lk9kRv9QiAQfNNrJvMQK-WkzbdLtvdCLzUU2WGolB4niL8Xq3Rl3ywQ3knKeZPAIqhjJhVYVS0oxhbmZCvu4Vli4Zv6NZ5LWViMPrLGuHTKxD4j4RhByUn657DgbWETHZYn9K2ANDgDgJ9-NHFVec0kSbQa3aOQ0QfiZL4CL9x_DESri5HvrUMpsaheGlLs8eZNiKQGuyuTne1t-rupI3c30agj-LFBMgh3ZQnP8-gj28J0_I81zMk_bLnoppB5ABZq6gzVlOIujx0Vo0e_ekVBUgDhWWzHy80hM0KoC6_heAeGXlx2IRTJzhONT2qd8UvNlK1A7liYe5jVAJut76diHHPifydpeX74m6xFaFmBHRVclY7xdvhfj7XrM7HoYzvd65fAsJIZmSIvI4a2QY3We6X4LCDeDr_Q",
		"MIIFYDCCA0igAwIBAgIJAOj6GWMU0voYMA0GCSqGSIb3DQEBCwUAMBsxGTAXBgNVBAUTEGY5MjAwOWU4NTNiNmIwNDUwHhcNMTYwNTI2MTYyODUyWhcNMjYwNTI0MTYyODUyWjAbMRkwFwYDVQQFExBmOTIwMDllODUzYjZiMDQ1MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAr7bHgiuxpwHsK7Qui8xUFmOr75gvMsd_dTEDDJdSSxtf6An7xyqpRR90PL2abxM1dEqlXnf2tqw1Ne4Xwl5jlRfdnJLmN0pTy_4lj4_7tv0Sk3iiKkypnEUtR6WfMgH0QZfKHM1-di-y9TFRtv6y__0rb-T-W8a9nsNL_ggjnar86461qO0rOs2cXjp3kOG1FEJ5MVmFmBGtnrKpa73XpXyTqRxB_M0n1n_W9nGqC4FSYa04T6N5RIZGBN2z2MT5IKGbFlbC8UrW0DxW7AYImQQcHtGl_m00QLVWutHQoVJYnFPlXTcHYvASLu-RhhsbDmxMgJJ0mcDpvsC4PjvB-TxywElgS70vE0XmLD-OJtvsBslHZvPBKCOdT0MS-tgSOIfga-z1Z1g7-DVagf7quvmag8jfPioyKvxnK_EgsTUVi2ghzq8wm27ud_mIM7AY2qEORR8Go3TVB4HzWQgpZrt3i5MIlCaY504LzSRiigHCzAPlHws-W0rB5N-er5_2pJKnfBSDiCiFAVtCLOZ7gLiMm0jhO2B6tUXHI_-MRPjy02i59lINMRRev56GKtcd9qO_0kUJWdZTdA2XoS82ixPvZtXQpUpuL12ab-9EaDK8Z4RHJYYfCT3Q5vNAXaiWQ-8PTWm2QgBR_bkwSWc-NpUFgNPN9PvQi8WEg5UmAGMCAwEAAaOBpjCBozAdBgNVHQ4EFgQUNmHhAHyIBQlRi0RsR_8aTMnqTxIwHwYDVR0jBBgwFoAUNmHhAHyIBQlRi0RsR_8aTMnqTxIwDwYDVR0TAQH_BAUwAwEB_zAOBgNVHQ8BAf8EBAMCAYYwQAYDVR0fBDkwNzA1oDOgMYYvaHR0cHM6Ly9hbmRyb2lkLmdvb2dsZWFwaXMuY29tL2F0dGVzdGF0aW9uL2NybC8wDQYJKoZIhvcNAQELBQADggIBACDIw41L3KlXG0aMiS__cqrG-EShHUGo8HNsw30W1kJtjn6UBwRM6jnmiwfBPb8VA91chb2vssAtX2zbTvqBJ9-LBPGCdw_E53Rbf86qhxKaiAHOjpvAy5Y3m00mqC0w_Zwvju1twb4vhLaJ5NkUJYsUS7rmJKHHBnETLi8GFqiEsqTWpG_6ibYCv7rYDBJDcR9W62BW9jfIoBQcxUCUJouMPH25lLNcDc1ssqvC2v7iUgI9LeoM1sNovqPmQUiG9rHli1vXxzCyaMTjwftkJLkf6724DFhuKug2jITV0QkXvaJWF4nUaHOTNA4uJU9WDvZLI1j83A-_xnAJUucIv_zGJ1AMH2boHqF8CY16LpsYgBt6tKxxWH00XcyDCdW2KlBCeqbQPcsFmWyWugxdcekhYsAWyoSf818NUsZdBWBaR_OukXrNLfkQ79IyZohZbvabO_X-MVT3rriAoKc8oE2Uws6DF-60PV7_WIPjNvXySdqspImSN78mflxDqwLqRBYkA3I75qppLGG9rp7UCdRjxMl8ZDBld-7yvHVgt1cVzJx9xnyGCC23UaicMDSXYrB4I4WHXPGjxhZuCuPBLTdOLU8YRvMYdEvYebWHMpvwGCF6bAx3JBpIeOQ1wDB5y0USicV3YgYGmi-NZfhA4URSh77Yd6uuJOJENRaNVTzk",
	}

	var certs []*x509.Certificate
	for _, str := range certStrings {
		der, err := base64.RawURLEncoding.DecodeString(str)
		if nil != err {
			panic(err)
		}

		cert, err := x509.ParseCertificate(der)
		if nil != err {
			panic(err)
		}

		certs = append(certs, cert)
	}

	desc, err := FindKeyDescription(certs[0])
	if nil != err || nil == desc {
		t.Fatalf("first certificate does not have a key description: %v", err)
	}

	_, err = Verify(time.Unix(1649586562, 0), certs[0], certs[1:])
	if nil != err {
		t.Fatalf("could not verify attestation of example certificates: %v", err)
	}
}
